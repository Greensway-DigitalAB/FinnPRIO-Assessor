

points_main <- get_points_as_table(expquest)

res <- c(testent,testest, testimp, testman)

df <- tibble(
  name = names(res),
  Question = sub("_.*", "", names(res)),
  Option = sub(".*_", "", names(res)),
  Answer = res
) |>
  unnest(cols = c(Answer))  # This expands each vector into separate rows

df_points <- df |> 
  left_join(points_main, by = c("Question", "Option"))


# Step 1: Filter EST2 and EST3
est2 <- df_points |> filter(Question == "EST2")
est3 <- df_points |> filter(Question == "EST3")

# Step 2: Merge EST2 and EST3 by Answer type
merged_est2_3 <- bind_rows(est2, est3) |> 
  group_by(Answer) |> 
  summarise(
    est2_options = Option[Question == "EST2"],
    est3_options = Option[Question == "EST3"],
    .groups = "drop"
  ) |> 
  mutate(
    Points = mapply(get_table3_points, est2_options, est3_options, MoreArgs = list(table3 = table3_lexp)),
    Question = "EST2+3"
  ) |> 
  select(Question, Answer, Points)

# Step 3: Filter out EST2 and EST3 from original data
df_clean <- df_points  |> 
  filter(!Question %in% c("EST2", "EST3"))  |> 
  select(Question, Answer, Points) |> 
  mutate(Points = as.numeric(Points))

# Step 4: Combine and pivot
final <- bind_rows(df_clean, merged_est2_3)  |> 
  pivot_wider(names_from = Answer, values_from = Points) |> 
  as.data.frame()

final_opt <- df_points |> 
  select(Question, Answer, Option) |> 
  pivot_wider(names_from = Answer, values_from = Option) |> 
  as.data.frame()

points_path <- get_points_as_table(expquest2)
res <- testpath

df <- tibble(
  name = names(res),
  Question = sub("_.*", "", names(res)),
  Path = lapply(str_split(names(res), "_"), function(x) x[2]) |> unlist(),
  Option = sub(".*_", "", names(res)),
  Answer = res
) |>
  unnest(cols = c(Answer))  # This expands each vector into separate rows

df_points <- df |> 
  left_join(points_path, by = c("Question", "Option"))

# Step 1: Filter ENT3
ent2A <- df_points |> filter(Question == "ENT2A")
ent2B <- df_points |> filter(Question == "ENT2B")
ent3 <- df_points |> filter(Question == "ENT3")

# Step 2: Merge ENT2 and ENT3 by Answer type
ent2a_3 <- bind_rows(ent2A, ent3) |> 
  group_by(Answer, Path) |> 
  summarise(
    ent2a_options = Option[Question == "ENT2A"],
    ent3_options = Option[Question == "ENT3"],
    .groups = "drop"
  ) |> 
  mutate(
    Points = mapply(get_table2_points, ent2a_options, ent3_options, MoreArgs = list(table2 = table2_lexp)),
    Question = "ENT3A"
  ) |> 
  select(Path, Question, Answer, Points)
  
ent2b_3 <- bind_rows(ent2B, ent3) |> 
  group_by(Answer, Path) |> 
  summarise(
    ent2b_options = Option[Question == "ENT2B"],
    ent3_options = Option[Question == "ENT3"],
    .groups = "drop"
  ) |> 
  mutate(
    Points = mapply(get_table2_points, ent2b_options, ent3_options, MoreArgs = list(table2 = table2_lexp)),
    Question = "ENT3B"
  ) |> 
  select(Path, Question, Answer, Points)
  

# Step 3: Filter out ENT3 from original data
df_clean <- df_points  |> 
  filter(!Question %in% c("ENT3"))  |> 
  select(Path, Question, Answer, Points) |> 
  mutate(Points = as.numeric(Points))

# Step 4: Combine and pivot
final <- bind_rows(df_clean, ent2a_3, ent2b_3)  |> 
  pivot_wider(names_from = Answer, values_from = Points) |> 
  as.data.frame()


final_opt <- df_points |> 
  select(Path, Question, Answer, Option) |> 
  pivot_wider(names_from = Answer, values_from = Option) |> 
  as.data.frame()